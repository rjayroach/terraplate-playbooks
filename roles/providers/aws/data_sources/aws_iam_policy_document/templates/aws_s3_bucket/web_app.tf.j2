data "aws_iam_policy_document" "{{ component.key.split('/') | last }}" {
  statement  {
    effect = "Allow"
    sid = "PublicReadGetObject"
    actions = ["s3:GetObject"]
    resources = ["arn:aws:s3:::{{ component.value._metadata.aws_s3_bucket_name }}/*"]
    principals {
      type        = "AWS"
      identifiers = ["*"]
    }
  }
{% if component.value._metadata.aws_iam_user_arn is defined %}

  statement {
    effect    = "Allow"
    sid       = "Stmt1EmberCLIS3DeployPolicy"
    actions   = [
      "s3:GetObject",
      "s3:PutObject",
      "s3:PutObjectACL",
    ]
    resources = [
      "arn:aws:s3:::{{ component.value._metadata.aws_s3_bucket_name }}/*",
    ]
    principals {
      type        = "AWS"
      identifiers = ["{{ component.value._metadata.aws_iam_user_arn }}"]
    }
  }
{% endif %}
{% if component.cidr_blocks is defined and component.cidr_blocks != "0.0.0.0/0" %}

  statement {
    effect    = "Deny"
    sid       = "IPDeny"
    actions   = [
      "s3:*",
    ]
    resources = [
      "arn:aws:s3:::{{ component.value._metadata.aws_s3_bucket_name }}/*",
    ]
    principals {
      type        = "AWS"
      identifiers = ["*"]
    }
    condition = {
      test     = "IpAddress"
      variable = "aws:SourceIp"
      values   = [
        "0.0.0.0/0"
      ]
    }
    condition = {
      test     = "NotIpAddress"
      variable = "aws:SourceIp"
      values   = [
        "{{ component.cidr_blocks }}"
      ]
    }
  }
{% endif %}
}
